#!/usr/bin/env bash
#
# dot
#
# `dot` handles installation, updates, and maintenance of your dotfiles.
# Run it periodically to make sure you're on the latest and greatest.

set -e

# Color codes
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Directories
parentDirectory="$(cd "$( dirname "${BASH_SOURCE[0]-$0}" )" && pwd -P)"
dotfilesDirectory="$(cd "$( dirname "$parentDirectory" )" && pwd -P)"
export DOTFILES="$dotfilesDirectory"

# Helper functions
info () {
  printf "\r  [ \033[00;34m..\033[0m ] $1\n"
}

user () {
  printf "\r  [ \033[0;33m??\033[0m ] $1\n"
}

success () {
  printf "\r\033[2K  [ \033[00;32mOK\033[0m ] $1\n"
}

fail () {
  printf "\r\033[2K  [\033[0;31mFAIL\033[0m] $1\n"
  echo ''
  exit 1
}

displayUsageAndExit() {
	echo "dot -- dotfiles management"
	echo ""
	echo "Usage: dot [command] [options]"
	echo ""
	echo "Commands:"
	echo "  bootstrap     First-time setup (gitconfig, symlinks, Homebrew)"
	echo "  install       Full installation (Homebrew packages, configs, macOS defaults)"
	echo "  update        Smart updates (default - only update what's needed)"
	echo ""
	echo "Options:"
	echo "  -e, --edit    Open dotfiles directory for editing"
	echo "  -h, --help    Show this help message and exit"
	echo ""
	echo "Examples:"
	echo "  dot              # Run smart updates (default)"
	echo "  dot bootstrap    # First-time setup"
	echo "  dot install      # Full installation"
	exit
}

# Ensure sudo credentials are available when needed
ensure_sudo() {
	if ! sudo -n true 2>/dev/null; then
		echo ""
		echo "ðŸ” Administrator password required for system configuration"
		sudo -v
		echo ""
	fi
	# Keep sudo alive in background
	while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

# Setup gitconfig if it doesn't exist
setup_gitconfig () {
	if ! [ -f "$DOTFILES/git/gitconfig.local.symlink" ]; then
		echo ""
		echo "ðŸ“ Setting up Git configuration..."
		echo ""

		git_credential='cache'
		if [ "$(uname -s)" == "Darwin" ]; then
			git_credential='osxkeychain'
		fi

		user ' - What is your GitHub author name?'
		read -e git_authorname
		user ' - What is your GitHub author email?'
		read -e git_authoremail

		sed -e "s/AUTHOR_NAME/$git_authorname/g" \
			-e "s/AUTHOR_EMAIL/$git_authoremail/g" \
			-e "s/GIT_CREDENTIAL_HELPER/$git_credential/g" \
			"$DOTFILES/git/gitconfig.local.symlink.example" > "$DOTFILES/git/gitconfig.local.symlink"

		echo -e "  ${GREEN}âœ“ Git configuration created${NC}"
	else
		echo -e "  ${GREEN}âœ“ Git configuration already exists${NC}"
	fi
}

# Link a single file
link_file () {
	local src=$1 dst=$2

	local overwrite= backup= skip=
	local action=

	if [ -f "$dst" -o -d "$dst" -o -L "$dst" ]; then
		if [ "$overwrite_all" == "false" ] && [ "$backup_all" == "false" ] && [ "$skip_all" == "false" ]; then
			local currentSrc="$(readlink $dst)"

			if [ "$currentSrc" == "$src" ]; then
				skip=true;
			else
				user "File already exists: $dst ($(basename "$src")), what do you want to do?\n\
				[s]kip, [S]kip all, [o]verwrite, [O]verwrite all, [b]ackup, [B]ackup all?"
				read -n 1 action

				case "$action" in
					o )
						overwrite=true;;
					O )
						overwrite_all=true;;
					b )
						backup=true;;
					B )
						backup_all=true;;
					s )
						skip=true;;
					S )
						skip_all=true;;
					* )
						;;
				esac
			fi
		fi

		overwrite=${overwrite:-$overwrite_all}
		backup=${backup:-$backup_all}
		skip=${skip:-$skip_all}

		if [ "$overwrite" == "true" ]; then
			rm -rf "$dst"
			success "removed $dst"
		fi

		if [ "$backup" == "true" ]; then
			mv "$dst" "${dst}.backup"
			success "moved $dst to ${dst}.backup"
		fi

		if [ "$skip" == "true" ]; then
			success "skipped $src"
		fi
	fi

	if [ "$skip" != "true" ]; then
		ln -s "$1" "$2"
		success "linked $1 to $2"
	fi
}

# Install/update dotfile symlinks
install_dotfiles () {
	local is_update=$1

	echo ""
	if [ "$is_update" == "true" ]; then
		echo "ðŸ”— Checking dotfile symlinks..."
	else
		echo "ðŸ”— Installing dotfile symlinks..."
	fi

	local overwrite_all=false backup_all=false skip_all=false
	local linked_count=0
	local skipped_count=0

	for src in $(find -H "$DOTFILES" -maxdepth 2 -name '*.symlink' -not -path '*.git*'); do
		dst="$HOME/.$(basename "${src%.*}")"

		# Check if symlink already exists and is correct
		if [ -L "$dst" ] && [ "$(readlink $dst)" == "$src" ]; then
			((skipped_count++))
		else
			link_file "$src" "$dst"
			((linked_count++))
		fi
	done

	if [ $linked_count -gt 0 ]; then
		echo -e "  ${GREEN}âœ“ Linked $linked_count dotfile(s)${NC}"
	fi
	if [ $skipped_count -gt 0 ] && [ "$is_update" == "true" ]; then
		echo -e "  ${GREEN}âœ“ $skipped_count dotfile(s) already up to date${NC}"
	fi
}

# Bootstrap: First-time setup
cmd_bootstrap() {
	echo ""
	echo "============================================================"
	echo -e "${BLUE}ðŸš€ Bootstrapping dotfiles...${NC}"
	echo "============================================================"

	setup_gitconfig
	install_dotfiles false

	echo ""
	echo "ðŸº Checking for Homebrew..."
	if command -v brew &> /dev/null; then
		echo -e "  ${GREEN}âœ“ Homebrew is already installed${NC}"
	else
		echo ""
		echo "  Installing Homebrew..."
		/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
		echo -e "  ${GREEN}âœ“ Homebrew installed${NC}"
	fi

	echo ""
	echo -e "${GREEN}âœ¨ Bootstrap complete!${NC}"
	echo ""
	user "Would you like to run the full installation now? (y/n)"
	read -n 1 run_install
	echo ""

	if [[ $run_install =~ ^[Yy]$ ]]; then
		cmd_install
	else
		echo "ðŸ’¡ Run 'dot install' when you're ready to complete the setup."
		echo ""
	fi
}

# Install: Full installation
cmd_install() {
	echo ""
	echo "============================================================"
	echo -e "${BLUE}ðŸ“¦ Running full installation...${NC}"
	echo "============================================================"

	# Ensure symlinks are up to date
	install_dotfiles true

	echo ""
	echo "ðŸº Installing Homebrew packages..."
	echo ""
	cd "$DOTFILES"
	brew bundle install
	echo -e "  ${GREEN}âœ“ Homebrew packages installed${NC}"

	echo ""
	echo "============================================================"
	echo -e "${BLUE}âš™ï¸  Running installer scripts...${NC}"
	echo "============================================================"

	# Run macOS installer first
	if [ -f "$DOTFILES/macos/install.sh" ]; then
		source "$DOTFILES/macos/install.sh"
	fi

	# Run FNM installer
	if [ -f "$DOTFILES/fnm/install.sh" ]; then
		echo ""
		echo -e "${BLUE}ðŸ”§ Setting up FNM and Node.js...${NC}"

		# Remove Homebrew's node if it was installed as a dependency
		if brew list node &>/dev/null; then
			echo -e "  ${YELLOW}âš ï¸  Removing Homebrew's Node (we use FNM instead)${NC}"
			brew uninstall --ignore-dependencies node 2>/dev/null || true
			echo -e "  ${GREEN}âœ“ Homebrew Node removed${NC}"
		fi

		# Set up FNM environment
		eval "$(fnm env --use-on-cd --version-file-strategy=recursive --corepack-enabled --shell bash)"

		# Check if LTS is already installed and set as default
		CURRENT_NODE=$(fnm current 2>/dev/null || echo "none")
		if fnm list | grep -q "lts-latest" && [ "$CURRENT_NODE" != "none" ]; then
			echo -e "  ${GREEN}âœ“ Node.js LTS already installed: $CURRENT_NODE${NC}"
		else
			echo ""
			echo "  Installing latest Node.js LTS version..."
			fnm install --lts
			fnm default lts-latest
			echo -e "  ${GREEN}âœ“ Installed Node.js $(fnm current)${NC}"
		fi

		# Create or update symlinks to the default FNM Node version for system-wide access
		SYMLINKS_NEEDED=false
		for cmd in node npm npx corepack; do
			if [ ! -L "/usr/local/bin/$cmd" ] || [ "$(readlink /usr/local/bin/$cmd)" != "$HOME/.local/share/fnm/aliases/default/bin/$cmd" ]; then
				SYMLINKS_NEEDED=true
				break
			fi
		done

		if [ "$SYMLINKS_NEEDED" = true ]; then
			echo ""
			echo "  Creating symlinks for global Node.js access..."

			ensure_sudo

			sudo mkdir -p /usr/local/bin
			sudo ln -sf "$HOME/.local/share/fnm/aliases/default/bin/node" /usr/local/bin/node
			sudo ln -sf "$HOME/.local/share/fnm/aliases/default/bin/npm" /usr/local/bin/npm
			sudo ln -sf "$HOME/.local/share/fnm/aliases/default/bin/npx" /usr/local/bin/npx
			sudo ln -sf "$HOME/.local/share/fnm/aliases/default/bin/corepack" /usr/local/bin/corepack
			echo -e "  ${GREEN}âœ“ Symlinks created${NC}"
		else
			echo -e "  ${GREEN}âœ“ Symlinks already configured correctly${NC}"
		fi

		echo ""
		echo -e "${GREEN}âœ“ FNM setup complete!${NC}"
		echo "  ðŸ“¦ node: $(node --version)"
		echo "  ðŸ“¦ npm: $(npm --version)"
		echo "  ðŸ“¦ npx: $(npx --version)"
		echo "  ðŸ“¦ corepack: $(corepack --version)"
	fi

	# Run zsh installer
	if [ -f "$DOTFILES/zsh/install.sh" ]; then
		source "$DOTFILES/zsh/install.sh"
	fi

	# Set macOS defaults
	if [ -f "$DOTFILES/macos/set-defaults.sh" ]; then
		echo ""
		echo "============================================================"
		echo -e "${BLUE}ðŸ Configuring macOS defaults...${NC}"
		echo "============================================================"

		ensure_sudo

		source "$DOTFILES/macos/set-defaults.sh"
	fi

	echo ""
	echo -e "${GREEN}âœ¨ Installation complete! Your machine is fully configured.${NC}"
	echo ""
	echo "ðŸ’¡ Run 'dot' or 'dot update' periodically to keep things up-to-date."
	echo ""
}

# Update: Smart periodic updates
cmd_update() {
	echo ""
	echo "============================================================"
	echo -e "${BLUE}ðŸ”„ Running smart updates...${NC}"
	echo "============================================================"

	# Check and update symlinks
	install_dotfiles true

	echo ""
	echo "============================================================"
	echo -e "${BLUE}ðŸº Updating Homebrew...${NC}"
	echo "============================================================"

	echo ""
	echo "ðŸ” Checking for Homebrew updates..."
	echo ""
	brew update
	echo -e "  ${GREEN}âœ“ Homebrew updated${NC}"

	echo ""
	echo "ðŸ“¦ Checking for package updates..."
	# Check if there are any outdated packages before upgrading
	OUTDATED=$(brew outdated)
	if [ -n "$OUTDATED" ]; then
		echo "$OUTDATED" | sed 's/^/  /'
		echo ""
		brew upgrade
		echo -e "  ${GREEN}âœ“ Packages upgraded${NC}"
	else
		echo -e "  ${GREEN}âœ“ All packages are up to date${NC}"
	fi

	echo ""
	echo "ðŸ“¦ Checking Brewfile for missing packages..."
	cd "$DOTFILES"
	# Use brew bundle check to see if anything is missing
	if ! brew bundle check &>/dev/null; then
		echo ""
		echo "  Installing missing packages..."
		brew bundle install
		echo -e "  ${GREEN}âœ“ Missing packages installed${NC}"
	else
		echo -e "  ${GREEN}âœ“ All Brewfile packages are installed${NC}"
	fi

	# Remove Homebrew's node if it was installed as a dependency (we use FNM)
	if brew list node &>/dev/null; then
		echo ""
		echo -e "  ${YELLOW}âš ï¸  Detected Homebrew Node version${NC}"
		echo "  Removing in favor of FNM version..."
		brew uninstall --ignore-dependencies node 2>/dev/null || true
		echo -e "  ${GREEN}âœ“ Homebrew Node removed${NC}"
	fi

	echo ""
	echo "ðŸ§¹ Cleaning up Homebrew..."
	brew cleanup
	echo -e "  ${GREEN}âœ“ Cleanup complete${NC}"

	echo ""
	echo -e "${GREEN}âœ¨ Updates complete!${NC}"
	echo ""
}

# Main command dispatcher
main() {
	local command="${1:-update}"

	case "$command" in
		"-h"|"--help")
			displayUsageAndExit
			;;
		"-e"|"--edit")
			exec "$EDITOR" "$dotfilesDirectory"
			exit
			;;
		"bootstrap")
			cmd_bootstrap
			;;
		"install")
			cmd_install
			;;
		"update")
			cmd_update
			;;
		*)
			# If unknown command, try to parse as option
			if [[ "$command" == -* ]]; then
				echo "Invalid option: $command"
				displayUsageAndExit
			else
				echo "Unknown command: $command"
				displayUsageAndExit
			fi
			;;
	esac
}

main "$@"
